<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hostel Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow-x: hidden;
}

body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

.page {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.4s;
  width: 100%;
  height: 100vh;
  padding: 20px;
  background: linear-gradient(135deg, #e8f0ff, #ffffff, #d9e9ff);
}

#welcomePage {
  position: relative;
  overflow: hidden;
}

#welcomePage::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url("https://images.adsttc.com/media/images/664c/e719/c1b8/0045/11c7/79b2/large_jpg/girls-college-and-hostel-for-model-education-trust-neogenesis-plus-studi0261_9.jpg")
              no-repeat center center/cover;
  filter: blur(2px);
  transform: scale(1.05);
  z-index: 0;
}

#welcomePage * {
  position: relative;
  z-index: 1;
}

h1 {
  font-size: 42px;
  font-weight: 800;
  margin-bottom: 25px;
  color: #000;
  text-shadow: 2px 2px 0 #d4d4d4, 4px 4px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
}

#welcomePage h1 {
  color: white;
  text-shadow: 2px 2px 10px black;
}

.arrow-btn,
.btn,
.neon-btn,
.back-btn {
  cursor: pointer;
  border: none;
  border-radius: 10px;
  transition: 0.3s;
}

.arrow-btn {
  width: 70px;
  height: 70px;
  font-size: 32px;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  background: black;
  color: #fff;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  margin-top: 15px;
}

.arrow-btn:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
}

.btn {
  padding: 12px 25px;
  font-size: 16px;
  font-weight: 600;
  background: #fff;
  border: 2px solid #bfc8ff;
  color: #111;
  margin: 8px;
  box-shadow: 0 4px 0 #bfc8ff, 0 8px 15px rgba(0, 0, 0, 0.1);
}

.btn:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 0 #aab5ff, 0 10px 20px rgba(0, 0, 0, 0.15);
}

.btn:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 #8f9bff, 0 6px 12px rgba(0, 0, 0, 0.1);
}

.neon-btn,
.back-btn {
  padding: 12px 25px;
  font-size: 18px;
  font-weight: 600;
  background: #0a0a0a;
  color: #fff;
  border: 2px solid #6e7aff;
}

.neon-btn:hover,
.back-btn:hover {
  box-shadow: 0 0 15px #6e7aff, 0 0 25px #6e7aff;
  color: #cdd3ff;
}

.input-box {
  width: 260px;
  padding: 12px;
  margin: 8px 0;
  font-size: 16px;
  border-radius: 8px;
  border: 1.5px solid #a7b2ff;
  box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
}

.input-box:focus {
  outline: none;
  border-color: #6e7aff;
  box-shadow: 0 0 8px rgba(110, 122, 255, 0.4);
}

.horizontal-btns {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 15px;
}

.fee-table {
  width: 90%;
  max-width: 600px;
  margin-top: 12px;
}

.fee-table table {
  width: 100%;
  border-collapse: collapse;
}

.fee-table th,
.fee-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.fee-table th {
  background: #f2f4ff;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.request-card, .review-card, .student-detail-card {
  background: #fff;
  padding: 16px;
  margin: 12px 0;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
  width: 100%;
}

.request-header, .student-detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.request-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 15px;
}

.request-detail-item {
  display: flex;
  flex-direction: column;
  padding: 8px;
  background: #f8f9ff;
  border-radius: 6px;
}

.request-detail-label {
  font-weight: 600;
  font-size: 14px;
  color: #555;
  margin-bottom: 4px;
}

.request-detail-value {
  font-size: 15px;
}

.request-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 10px;
}

.request-status {
  font-weight: 600;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 14px;
}

.status-pending { background: orange; color: #fff; }
.status-approved { background: green; color: #fff; }
.status-rejected { background: red; color: #fff; }

.danger-btn {
  background: red;
  color: white;
  padding: 12px 25px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  margin: 8px;
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.login-type-selector {
  display: flex;
  margin-bottom: 20px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.login-type-btn {
  padding: 10px 20px;
  background: #f0f2ff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  flex: 1;
  transition: all 0.3s;
}

.login-type-btn.active {
  background: #6e7aff;
  color: white;
}

.login-type-btn:not(.active):hover {
  background: #e0e5ff;
}

.priority-badge {
  background: #ff9800;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  margin-left: 8px;
}

.search-container {
  display: flex;
  gap: 10px;
  margin: 15px 0;
  width: 90%;
  max-width: 700px;
}

.search-input {
  flex: 1;
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 1.5px solid #a7b2ff;
  box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
}

.search-btn {
  padding: 12px 20px;
  background: #6e7aff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.amenities-list {
  font-size: 14px;
  text-align: left;
  line-height: 1.4;
}
</style>
</head>
<body>

<div id="welcomePage" class="page">
  <h1>Hostel Management System</h1>
  <button class="arrow-btn" onclick="showPage('mainLoginPage')">➜</button>
</div>

<!-- UPDATED: Single Login Page for both Student and Admin -->
<div id="mainLoginPage" class="page">
  <h1>Login Portal</h1>
  
  <!-- Single login form for both -->
  <input type="text" id="loginUser" class="input-box" placeholder="Enter Roll No / Username">
  <input type="password" id="loginPass" class="input-box" placeholder="Enter Password">
  
  <button class="btn" onclick="unifiedLogin()">Login</button>
  
  <!-- Student Signup Section -->
  <div id="studentSignupSection">
    <p style="margin-top:20px;">Don't have an account?</p>
    <button class="neon-btn" onclick="showPage('studentRegisterPage')">Sign Up</button>
  </div>
  
  <button class="back-btn" onclick="clearLoginForm(); showPage('welcomePage')">↩</button>
</div>

<div id="studentRegisterPage" class="page">
  <h1>Student Registration</h1>
  <input type="text" id="regName" class="input-box" placeholder="Enter Name">
  <input type="text" id="regRoll" class="input-box" placeholder="Enter Roll No">
  <input type="email" id="regEmail" class="input-box" placeholder="Enter Email-ID">
  <input type="text" id="regCourse" class="input-box" placeholder="Enter Course">
  <input type="password" id="regPass" class="input-box" placeholder="Set Password">
  <button class="btn" onclick="registerStudent()" id="registerBtn">Register</button>
  <button class="back-btn" onclick="clearRegistrationForm(); showPage('mainLoginPage')">↩</button>
</div>

<div id="studentDashboardPage" class="page">
  <h1>Welcome Student</h1>
  <div class="horizontal-btns">
    <button class="btn" onclick="showPage('hostelCategoryPage')">Hostel Form</button>
    <button class="btn" onclick="showPage('reviewPage')">Submit Anonymous Review</button>
    <button class="btn" onclick="checkApplicationStatus()">Check Application Status</button>
  </div>
  <button class="back-btn" onclick="logout()">↩ Logout</button>
</div>

<div id="hostelCategoryPage" class="page">
  <h1>Select Hostel Category</h1>
  <div class="horizontal-btns">
    <button class="btn" onclick="openACPage('Boys')">Boys Hostel</button>
    <button class="btn" onclick="openACPage('Girls')">Girls Hostel</button>
  </div>
  <button class="back-btn" onclick="showPage('studentDashboardPage')">↩</button>
</div>

<div id="hostelACPage" class="page">
  <h1>Select Hostel</h1>
  <div class="horizontal-btns">
    <button class="btn" onclick="chooseACType('Hostel 1 AC')">Hostel 1 (AC) – ₹30,000</button>
    <button class="btn" onclick="chooseACType('Hostel 2 Non-AC')">Hostel 2 (Non-AC) – ₹20,000</button>
  </div>
  <button class="back-btn" onclick="showPage('hostelCategoryPage')">↩</button>
</div>

<div id="hostelFormPage" class="page">
  <h1 id="hostelFormTitle">Hostel Application</h1>

  <label style="margin-top:12px;">Washroom:</label>
  <select id="hf_washroom" class="input-box">
    <option value="Attached">Attached - ₹15000</option>
    <option value="Common">Common - ₹10000</option>
  </select>

  <label>Occupancy:</label>
  <select id="hf_occupancy" class="input-box">
    <option value="Single">Single - ₹7000</option>
    <option value="Double">Double - ₹5000</option>
    <option value="Triple">Triple - ₹4000</option>
    <option value="Quad">Quad - ₹4000</option>
  </select>

  <label>Mess:</label>
  <select id="hf_mess" class="input-box">
    <option value="Veg">Veg - ₹10000</option>
    <option value="NonVeg">Veg + Non-Veg - ₹20000</option>
  </select>

  <label>Extras:</label>
  <div style="width:260px; text-align:left; margin:8px 0;">
    <label><input type="checkbox" id="hf_gym"> Gym (₹1000)</label><br>
    <label><input type="checkbox" id="hf_library"> Library (₹500)</label><br>
    <label><input type="checkbox" id="hf_cleaner"> Room Cleaner (₹700)</label>
  </div>

  <div id="hf_feeTable" class="fee-table"></div>

  <div style="display:flex; gap:10px; margin-top:12px;">
    <button class="btn" onclick="calculateHostelFees()">Calculate & Preview</button>
    <button class="back-btn" onclick="showPage('hostelACPage')">↩ Back</button>
  </div>

  <div style="margin-top:12px; display:flex; gap:10px;">
    <button class="btn" onclick="submitHostelApplication()" id="submitAppBtn">Submit Application</button>
    <button class="back-btn" onclick="clearHostelForm(); showPage('studentDashboardPage')">Cancel</button>
  </div>
</div>

<div id="reviewPage" class="page">
  <h1>Submit Anonymous Review</h1>

  <label>Mess:</label>
  <select id="rev_mess" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Laundry:</label>
  <select id="rev_laundry" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Gym:</label>
  <select id="rev_gym" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>WiFi:</label>
  <select id="rev_wifi" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Playground:</label>
  <select id="rev_playground" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Cleanliness:</label>
  <select id="rev_cleanliness" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Hostel Maintenance:</label>
  <select id="rev_maintenance" class="input-box">
    <option value="select" selected>select</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Comments / Suggestions:</label>
  <textarea id="rev_comments" class="input-box" placeholder="Write your comments or suggestions..." style="height:100px;"></textarea>

  <button class="btn" onclick="submitReview()" id="submitReviewBtn">Submit</button>
  <button class="back-btn" onclick="clearReviewForm(); showPage('studentDashboardPage')">↩</button>
</div>

<div id="applicationStatusPage" class="page">
  <h1>Your Application Status</h1>
  <div id="statusContainer" style="width:90%; max-width:700px;"></div>
  <button class="back-btn" onclick="showPage('studentDashboardPage')">↩</button>
</div>

<div id="adminDashboard" class="page">
  <h1>Welcome Admin</h1>
  <button class="btn" onclick="viewAllRequests()">View Requests</button>
  <button class="btn" onclick="viewAllReviews()">See Reviews</button>
  <button class="btn" onclick="loadStudents()">View Students</button>
  <button class="back-btn" onclick="logout()">↩ Logout</button>
</div>

<!-- UPDATED: Single delete button in all admin pages -->
<div id="adminRequestsPage" class="page">
  <h1>All Requests</h1>
  <div id="adminRequestsContainer" style="width:90%; max-width:700px;"></div>
  <button onclick="clearAllRequests()" class="danger-btn" style="margin-top: 20px;">Delete All Requests</button>
  <button class="back-btn" onclick="showPage('adminDashboard')">↩</button>
</div>

<div id="adminReviewsPage" class="page">
  <h1>Student Reviews</h1>
  <div id="adminReviewsContainer" style="width:90%; max-width:700px;"></div>
  <button onclick="clearAllReviews()" class="danger-btn" style="margin-top: 20px;">Delete All Reviews</button>
  <button class="back-btn" onclick="showPage('adminDashboard')">↩</button>
</div>

<div id="adminStudentDetails" class="page">
  <h1>All Students</h1>
  <div class="search-container">
    <input type="text" id="searchStudent" class="search-input" placeholder="Search Students by Name, Roll No, Email or Course...">
    <button class="search-btn" onclick="searchStudents()">Search</button>
  </div>
  <table style="width:90%; max-width:700px; border-collapse: collapse; margin-top:12px;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Roll No</th>
        <th>Email</th>
        <th>Course</th>
        <th>Amenities Chosen</th>
      </tr>
    </thead>
    <tbody id="studentTableBody"></tbody>
  </table>
  <button onclick="clearAllStudents()" class="danger-btn" style="margin-top: 20px;">Delete All Students</button>
  <button class="back-btn" onclick="showPage('adminDashboard')">↩</button>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCmZuXKxdxIG-oOGYYULfYZnHotQ_UkLfE",
  authDomain: "hostel-allocation-system-9b97f.firebaseapp.com",
  projectId: "hostel-allocation-system-9b97f",
  storageBucket: "hostel-allocation-system-9b97f.firebasestorage.app",
  messagingSenderId: "160944018594",
  appId: "1:160944018594:web:a6cf27dba04e3e55dd73fb"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global variables
let selectedCategory = ""; 
let selectedHostel = "";
let calculatedFee = 0;

// Initialize data in localStorage
function initializeData() {
    if (!localStorage.getItem('students')) {
        localStorage.setItem('students', JSON.stringify([]));
    }
    if (!localStorage.getItem('applications')) {
        localStorage.setItem('applications', JSON.stringify([]));
    }
    if (!localStorage.getItem('reviews')) {
        localStorage.setItem('reviews', JSON.stringify([]));
    }
}

// Form clearing functions
function clearLoginForm() {
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
}

function clearRegistrationForm() {
    document.getElementById('regName').value = '';
    document.getElementById('regRoll').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regCourse').value = '';
    document.getElementById('regPass').value = '';
}

function clearHostelForm() {
    document.getElementById('hf_washroom').value = 'Attached';
    document.getElementById('hf_occupancy').value = 'Single';
    document.getElementById('hf_mess').value = 'Veg';
    document.getElementById('hf_gym').checked = false;
    document.getElementById('hf_library').checked = false;
    document.getElementById('hf_cleaner').checked = false;
    document.getElementById('hf_feeTable').innerHTML = '';
    calculatedFee = 0;
    selectedCategory = '';
    selectedHostel = '';
}

function clearReviewForm() {
    document.querySelectorAll('#reviewPage select').forEach(select => {
        select.value = 'select';
    });
    document.getElementById('rev_comments').value = '';
}

// Separate Delete Functions - UPDATED: Single delete buttons
function clearAllRequests() {
    if (confirm("Are you sure? This will delete ALL hostel applications and requests.")) {
        localStorage.setItem('applications', JSON.stringify([]));
        // Also clear from Firebase
        db.collection('applications').get().then(snapshot => {
            snapshot.docs.forEach(doc => {
                db.collection('applications').doc(doc.id).delete();
            });
        });
        alert("All requests deleted successfully!");
        viewAllRequests(); // Refresh the page
    }
}

function clearAllReviews() {
    if (confirm("Are you sure? This will delete ALL student reviews.")) {
        localStorage.setItem('reviews', JSON.stringify([]));
        // Also clear from Firebase
        db.collection('reviews').get().then(snapshot => {
            snapshot.docs.forEach(doc => {
                db.collection('reviews').doc(doc.id).delete();
            });
        });
        alert("All reviews deleted successfully!");
        viewAllReviews(); // Refresh the page
    }
}

function clearAllStudents() {
    if (confirm("Are you sure? This will delete ALL student registrations and their applications.")) {
        localStorage.setItem('students', JSON.stringify([]));
        localStorage.setItem('applications', JSON.stringify([]));
        // Also clear from Firebase
        db.collection('students').get().then(snapshot => {
            snapshot.docs.forEach(doc => {
                db.collection('students').doc(doc.id).delete();
            });
        });
        db.collection('applications').get().then(snapshot => {
            snapshot.docs.forEach(doc => {
                db.collection('applications').doc(doc.id).delete();
            });
        });
        alert("All students and their applications deleted successfully!");
        loadStudents(); // Refresh the page
    }
}

// Page navigation
function showPage(pageId) {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById(pageId).style.display = "flex";
}

// Registration function - UPDATED WITH FIREBASE
async function registerStudent() {
    let name = document.getElementById('regName').value.trim();
    let roll = document.getElementById('regRoll').value.trim();
    let email = document.getElementById('regEmail').value.trim();
    let course = document.getElementById('regCourse').value.trim();
    let pass = document.getElementById('regPass').value.trim();

    if (!name || !roll || !email || !course || !pass) {
        alert("Please fill all fields!");
        return;
    }

    // Show loading state
    const registerBtn = document.getElementById('registerBtn');
    registerBtn.innerHTML = '<span class="loading"></span> Registering...';
    registerBtn.disabled = true;

    try {
        // Firebase check
        const snapshot = await db.collection('students')
            .where('roll', '==', roll)
            .get();
        
        if (!snapshot.empty) {
            alert("Roll number already exists!");
            return;
        }
        
        // Save to Firebase
        await db.collection('students').add({
            name, roll, email, course, password: pass,
            createdAt: new Date()
        });

        // Also save to localStorage for backward compatibility
        const students = JSON.parse(localStorage.getItem('students'));
        const newStudent = { name, roll, email, course, pass };
        students.push(newStudent);
        localStorage.setItem('students', JSON.stringify(students));
        
        alert("Registration successful!");
        clearRegistrationForm();
        showPage("mainLoginPage");
    } catch (error) {
        console.error("Error registering student:", error);
        alert("Registration failed. Please try again.");
    } finally {
        // Reset button state
        registerBtn.innerHTML = 'Register';
        registerBtn.disabled = false;
    }
}

// UPDATED: Single Login Function for both Student and Admin
async function unifiedLogin() {
    let username = document.getElementById('loginUser').value.trim();
    let password = document.getElementById('loginPass').value.trim();

    if (!username || !password) {
        alert("Enter username and password!");
        return;
    }

    // First check if it's admin login
    if (username === "admin" && password === "admin123") {
        clearLoginForm();
        showPage("adminDashboard");
        return;
    }

    // If not admin, check if it's student login
    try {
        const snapshot = await db.collection('students')
            .where('roll', '==', username)
            .where('password', '==', password)
            .get();
        
        if (!snapshot.empty) {
            const student = snapshot.docs[0].data();
            sessionStorage.setItem("loggedInStudent", JSON.stringify(student));
            clearLoginForm();
            showPage("studentDashboardPage");
        } else {
            // Fallback to localStorage for backward compatibility
            const students = JSON.parse(localStorage.getItem('students'));
            const student = students.find(s => s.roll === username && s.pass === password);
            
            if (student) {
                sessionStorage.setItem("loggedInStudent", JSON.stringify(student));
                clearLoginForm();
                showPage("studentDashboardPage");
            } else {
                alert("Invalid Credentials!");
            }
        }
    } catch (error) {
        console.error("Error during login:", error);
        alert("Login failed. Please try again.");
    }
}

// Logout function
function logout() {
    sessionStorage.removeItem("loggedInStudent");
    clearLoginForm();
    showPage("mainLoginPage");
}

// Hostel selection functions
function openACPage(category) {
    selectedCategory = category;
    showPage("hostelACPage");
}

function chooseACType(hostelName) {
    selectedHostel = hostelName;
    showPage("hostelFormPage");
}

// Fee calculation
function calculateHostelFees() {
    let washroom = document.getElementById('hf_washroom').value;
    let occupancy = document.getElementById('hf_occupancy').value;
    let mess = document.getElementById('hf_mess').value;
    let gym = document.getElementById('hf_gym').checked;
    let library = document.getElementById('hf_library').checked;
    let cleaner = document.getElementById('hf_cleaner').checked;

    let fee = 0;
    fee += selectedHostel.includes("AC") ? 30000 : 20000;
    fee += washroom === "Attached" ? 15000 : 10000;
    
    const occ = { Single: 7000, Double: 5000, Triple: 4000, Quad: 4000 };
    fee += occ[occupancy];
    fee += mess === "Veg" ? 10000 : 20000;
    
    if (gym) fee += 1000;
    if (library) fee += 500;
    if (cleaner) fee += 700;

    calculatedFee = fee;

    document.getElementById('hf_feeTable').innerHTML = `
        <table>
            <tr><th>Category</th><th>Selected</th><th>Fee</th></tr>
            <tr><td>Hostel</td><td>${selectedHostel}</td><td>₹${selectedHostel.includes("AC")?30000:20000}</td></tr>
            <tr><td>Washroom</td><td>${washroom}</td><td>₹${washroom==="Attached"?15000:10000}</td></tr>
            <tr><td>Occupancy</td><td>${occupancy}</td><td>₹${occ[occupancy]}</td></tr>
            <tr><td>Mess</td><td>${mess}</td><td>₹${mess==="Veg"?10000:20000}</td></tr>
            <tr><td>Gym</td><td>${gym?"Yes":"No"}</td><td>₹${gym?1000:0}</td></tr>
            <tr><td>Library</td><td>${library?"Yes":"No"}</td><td>₹${library?500:0}</td></tr>
            <tr><td>Cleaner</td><td>${cleaner?"Yes":"No"}</td><td>₹${cleaner?700:0}</td></tr>
            <tr><th>Total</th><td></td><th>₹${fee}</th></tr>
        </table>
    `;
}

// Submit hostel application - UPDATED: Prevent multiple applications
async function submitHostelApplication() {
    const student = JSON.parse(sessionStorage.getItem("loggedInStudent"));

    if (!student) {
        alert("You must log in first!");
        return;
    }

    if (calculatedFee === 0) {
        alert("Please calculate fees first!");
        return;
    }

    // UPDATED: Check if student already has an application (even if deleted from admin)
    try {
        const existingAppSnapshot = await db.collection('applications')
            .where('roll', '==', student.roll)
            .get();
        
        if (!existingAppSnapshot.empty) {
            alert("You have already submitted a hostel application! Please wait for admin to process it or delete it before submitting a new one.");
            return;
        }
    } catch (error) {
        console.error("Error checking existing application:", error);
    }

    // Also check localStorage
    const applications = JSON.parse(localStorage.getItem('applications'));
    const existingApp = applications.find(app => app.roll === student.roll);
    if (existingApp) {
        alert("You have already submitted a hostel application! Please wait for admin to process it or delete it before submitting a new one.");
        return;
    }

    const washroom = document.getElementById('hf_washroom').value;
    const occupancy = document.getElementById('hf_occupancy').value;
    const mess = document.getElementById('hf_mess').value;
    const gym = document.getElementById('hf_gym').checked;
    const library = document.getElementById('hf_library').checked;
    const cleaner = document.getElementById('hf_cleaner').checked;

    const newApp = {
        name: student.name,
        roll: student.roll,
        hostel: selectedHostel,
        category: selectedCategory,
        washroom, occupancy, mess, gym, library, cleaner,
        fee: calculatedFee,
        status: "Pending",
        date: new Date().toLocaleString(),
        createdAt: new Date(),
        timestamp: new Date().getTime() // For first-come-first-served priority
    };

    // Show loading state
    const submitBtn = document.getElementById('submitAppBtn');
    submitBtn.innerHTML = '<span class="loading"></span> Submitting...';
    submitBtn.disabled = true;

    try {
        // Save to Firebase
        await db.collection('applications').add(newApp);
        
        // Also save to localStorage for backward compatibility
        applications.push(newApp);
        localStorage.setItem('applications', JSON.stringify(applications));
        
        alert("Hostel Request Submitted Successfully!");
        clearHostelForm();
        showPage("studentDashboardPage");
    } catch (error) {
        console.error("Error submitting application:", error);
        alert("Submission failed. Please try again.");
    } finally {
        // Reset button state
        submitBtn.innerHTML = 'Submit Application';
        submitBtn.disabled = false;
    }
}

// Check application status
async function checkApplicationStatus() {
    const student = JSON.parse(sessionStorage.getItem("loggedInStudent"));
    
    const container = document.getElementById('statusContainer');
    container.innerHTML = '<p>Loading...</p>';
    
    try {
        // Check Firebase first
        const snapshot = await db.collection('applications')
            .where('roll', '==', student.roll)
            .get();
        
        if (!snapshot.empty) {
            const app = snapshot.docs[0].data();
            container.innerHTML = `
                <div class="request-card">
                    <div class="request-header">
                        <p><b>Application Details</b></p>
                        <span class="request-status ${app.status === "Pending" ? "status-pending" : app.status === "Approved" ? "status-approved" : "status-rejected"}">
                            ${app.status}
                        </span>
                    </div>
                    <div class="request-details">
                        <div class="request-detail-item">
                            <span class="request-detail-label">Category</span>
                            <span class="request-detail-value">${app.category}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Hostel</span>
                            <span class="request-detail-value">${app.hostel}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Washroom</span>
                            <span class="request-detail-value">${app.washroom}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Occupancy</span>
                            <span class="request-detail-value">${app.occupancy}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Mess</span>
                            <span class="request-detail-value">${app.mess}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Extras</span>
                            <span class="request-detail-value">${[app.gym && 'Gym', app.library && 'Library', app.cleaner && 'Cleaner'].filter(Boolean).join(', ') || 'None'}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Fee</span>
                            <span class="request-detail-value">₹${app.fee}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Date</span>
                            <span class="request-detail-value">${app.date}</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Fallback to localStorage
            const applications = JSON.parse(localStorage.getItem('applications'));
            const app = applications.find(a => a.roll === student.roll);
            
            if (!app) {
                container.innerHTML = "<p>No applications submitted yet.</p>";
            } else {
                container.innerHTML = `
                    <div class="request-card">
                        <div class="request-header">
                            <p><b>Application Details</b></p>
                            <span class="request-status ${app.status === "Pending" ? "status-pending" : app.status === "Approved" ? "status-approved" : "status-rejected"}">
                                ${app.status}
                            </span>
                        </div>
                        <div class="request-details">
                            <div class="request-detail-item">
                                <span class="request-detail-label">Category</span>
                                <span class="request-detail-value">${app.category}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Hostel</span>
                                <span class="request-detail-value">${app.hostel}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Washroom</span>
                                <span class="request-detail-value">${app.washroom}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Occupancy</span>
                                <span class="request-detail-value">${app.occupancy}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Mess</span>
                                <span class="request-detail-value">${app.mess}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Extras</span>
                                <span class="request-detail-value">${[app.gym && 'Gym', app.library && 'Library', app.cleaner && 'Cleaner'].filter(Boolean).join(', ') || 'None'}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Fee</span>
                                <span class="request-detail-value">₹${app.fee}</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="request-detail-label">Date</span>
                                <span class="request-detail-value">${app.date}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error("Error checking application status:", error);
        container.innerHTML = "<p>Error loading application status.</p>";
    }
    
    showPage("applicationStatusPage");
}

// Submit review
async function submitReview() {
    const student = JSON.parse(sessionStorage.getItem("loggedInStudent"));
    if (!student) { alert("You must log in first!"); return; }

    const cleanliness = document.getElementById('rev_cleanliness').value;
    const mess = document.getElementById('rev_mess').value;
    const laundry = document.getElementById('rev_laundry').value;
    const gym = document.getElementById('rev_gym').value;
    const wifi = document.getElementById('rev_wifi').value;
    const playground = document.getElementById('rev_playground').value;
    const maintenance = document.getElementById('rev_maintenance').value;
    const comments = document.getElementById('rev_comments').value.trim();

    if ([cleanliness,mess,laundry,gym,wifi,playground,maintenance].includes("select")) {
        alert("Please select all ratings!");
        return;
    }

    const newReview = { 
        cleanliness, mess, laundry, gym, wifi, playground, maintenance, 
        comments, date: new Date().toLocaleString(),
        createdAt: new Date()
    };

    // Show loading state
    const submitBtn = document.getElementById('submitReviewBtn');
    submitBtn.innerHTML = '<span class="loading"></span> Submitting...';
    submitBtn.disabled = true;

    try {
        // Save to Firebase
        await db.collection('reviews').add(newReview);
        
        // Also save to localStorage for backward compatibility
        const reviews = JSON.parse(localStorage.getItem('reviews'));
        reviews.push(newReview);
        localStorage.setItem('reviews', JSON.stringify(reviews));
        
        alert("Review submitted successfully!"); 
        clearReviewForm();
        showPage("studentDashboardPage");
    } catch (error) {
        console.error("Error submitting review:", error);
        alert("Review submission failed. Please try again.");
    } finally {
        // Reset button state
        submitBtn.innerHTML = 'Submit';
        submitBtn.disabled = false;
    }
}

// Admin functions
async function viewAllRequests() {
    const container = document.getElementById('adminRequestsContainer');
    container.innerHTML = '<p>Loading...</p>';
    
    try {
        // Get data from Firebase
        const snapshot = await db.collection('applications').get();
        let applications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Sort by timestamp for first-come-first-served priority
        applications.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        if (applications.length === 0) {
            container.innerHTML = "<p>No requests yet.</p>";
        } else {
            container.innerHTML = applications.map((a, index) => `
                <div class="request-card">
                    <div class="request-header">
                        <p><b>${a.name} (${a.roll})</b> <span class="priority-badge">#${index + 1}</span></p>
                        <span class="request-status ${a.status === "Pending" ? "status-pending" : a.status === "Approved" ? "status-approved" : "status-rejected"}">
                            ${a.status}
                        </span>
                    </div>
                    <div class="request-details">
                        <div class="request-detail-item">
                            <span class="request-detail-label">Category</span>
                            <span class="request-detail-value">${a.category}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Hostel</span>
                            <span class="request-detail-value">${a.hostel}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Washroom</span>
                            <span class="request-detail-value">${a.washroom}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Occupancy</span>
                            <span class="request-detail-value">${a.occupancy}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Mess</span>
                            <span class="request-detail-value">${a.mess}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Extras</span>
                            <span class="request-detail-value">${[a.gym && 'Gym', a.library && 'Library', a.cleaner && 'Cleaner'].filter(Boolean).join(', ') || 'None'}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Fee</span>
                            <span class="request-detail-value">₹${a.fee}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Date</span>
                            <span class="request-detail-value">${a.date}</span>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button onclick="updateStatus('${a.id}','${a.roll}','Approved')" class="btn">Approve</button>
                        <button onclick="updateStatus('${a.id}','${a.roll}','Rejected')" class="btn">Reject</button>
                    </div>
                </div>
            `).join("");
        }
    } catch (error) {
        console.error("Error loading requests:", error);
        // Fallback to localStorage
        const applications = JSON.parse(localStorage.getItem('applications'));
        
        // Sort by date for first-come-first-served priority
        applications.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (applications.length === 0) {
            container.innerHTML = "<p>No requests yet.</p>";
        } else {
            container.innerHTML = applications.map((a, index) => `
                <div class="request-card">
                    <div class="request-header">
                        <p><b>${a.name} (${a.roll})</b> <span class="priority-badge">#${index + 1}</span></p>
                        <span class="request-status ${a.status === "Pending" ? "status-pending" : a.status === "Approved" ? "status-approved" : "status-rejected"}">
                            ${a.status}
                        </span>
                    </div>
                    <div class="request-details">
                        <div class="request-detail-item">
                            <span class="request-detail-label">Category</span>
                            <span class="request-detail-value">${a.category}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Hostel</span>
                            <span class="request-detail-value">${a.hostel}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Washroom</span>
                            <span class="request-detail-value">${a.washroom}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Occupancy</span>
                            <span class="request-detail-value">${a.occupancy}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Mess</span>
                            <span class="request-detail-value">${a.mess}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Extras</span>
                            <span class="request-detail-value">${[a.gym && 'Gym', a.library && 'Library', a.cleaner && 'Cleaner'].filter(Boolean).join(', ') || 'None'}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Fee</span>
                            <span class="request-detail-value">₹${a.fee}</span>
                        </div>
                        <div class="request-detail-item">
                            <span class="request-detail-label">Date</span>
                            <span class="request-detail-value">${a.date}</span>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button onclick="updateStatus('${a.roll}','Approved')" class="btn">Approve</button>
                        <button onclick="updateStatus('${a.roll}','Rejected')" class="btn">Reject</button>
                    </div>
                </div>
            `).join("");
        }
    }
    showPage("adminRequestsPage");
}

async function updateStatus(id, roll, status) {
    try {
        // Update in Firebase
        if (id) {
            await db.collection('applications').doc(id).update({ status });
        }
        
        // Also update in localStorage for backward compatibility
        const applications = JSON.parse(localStorage.getItem('applications'));
        const appIndex = applications.findIndex(app => app.roll === roll);
        
        if (appIndex !== -1) {
            applications[appIndex].status = status;
            localStorage.setItem('applications', JSON.stringify(applications));
        }
        
        viewAllRequests();
    } catch (error) {
        console.error("Error updating status:", error);
        alert("Failed to update status. Please try again.");
    }
}

async function viewAllReviews() {
    const container = document.getElementById('adminReviewsContainer');
    container.innerHTML = '<p>Loading...</p>';
    
    try {
        // Get data from Firebase
        const snapshot = await db.collection('reviews').get();
        const reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (reviews.length === 0) {
            container.innerHTML = "<p>No reviews yet.</p>";
        } else {
            container.innerHTML = reviews.map((r, index) => {
                const avg = ((+r.mess + +r.laundry + +r.gym + +r.wifi + +r.playground + +r.cleanliness + +r.maintenance) / 7).toFixed(1);
                return `
                    <div class="review-card">
                        <p><b>Review #${index + 1}</b> - ${r.date}</p>
                        <p><b>Ratings:</b></p>
                        <p>Mess: ${r.mess}/5 | Laundry: ${r.laundry}/5 | Gym: ${r.gym}/5</p>
                        <p>WiFi: ${r.wifi}/5 | Playground: ${r.playground}/5</p>
                        <p>Cleanliness: ${r.cleanliness}/5 | Maintenance: ${r.maintenance}/5</p>
                        <p><b>Average Rating:</b> ${avg}/5</p>
                        <p><b>Comments:</b> ${r.comments || "No comments"}</p>
                    </div>
                `;
            }).join("");
        }
    } catch (error) {
        console.error("Error loading reviews:", error);
        // Fallback to localStorage
        const reviews = JSON.parse(localStorage.getItem('reviews'));
        
        if (reviews.length === 0) {
            container.innerHTML = "<p>No reviews yet.</p>";
        } else {
            container.innerHTML = reviews.map((r, index) => {
                const avg = ((+r.mess + +r.laundry + +r.gym + +r.wifi + +r.playground + +r.cleanliness + +r.maintenance) / 7).toFixed(1);
                return `
                    <div class="review-card">
                        <p><b>Review #${index + 1}</b> - ${r.date}</p>
                        <p><b>Ratings:</b></p>
                        <p>Mess: ${r.mess}/5 | Laundry: ${r.laundry}/5 | Gym: ${r.gym}/5</p>
                        <p>WiFi: ${r.wifi}/5 | Playground: ${r.playground}/5</p>
                        <p>Cleanliness: ${r.cleanliness}/5 | Maintenance: ${r.maintenance}/5</p>
                        <p><b>Average Rating:</b> ${avg}/5</p>
                        <p><b>Comments:</b> ${r.comments || "No comments"}</p>
                    </div>
                `;
            }).join("");
        }
    }
    showPage("adminReviewsPage");
}

// NEW: Search Students Function
function searchStudents() {
    const search = document.getElementById('searchStudent').value.toLowerCase();
    filterStudents(search);
}

// UPDATED: Filter Students Function
function filterStudents(searchTerm = '') {
    const students = JSON.parse(localStorage.getItem('students'));
    const applications = JSON.parse(localStorage.getItem('applications'));
    
    // If no search term provided, show all students
    const filtered = searchTerm ? students.filter(s => 
        s.name.toLowerCase().includes(searchTerm) || 
        s.roll.toLowerCase().includes(searchTerm) ||
        s.email.toLowerCase().includes(searchTerm) ||
        s.course.toLowerCase().includes(searchTerm)
    ) : students;
    
    const tbody = document.getElementById('studentTableBody');
    
    if (filtered.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>No matching students found.</td></tr>";
    } else {
        tbody.innerHTML = filtered.map(s => {
            const studentApp = applications.find(app => app.roll === s.roll);
            
            // IMPROVED: Show amenities properly
            let amenities = 'No application submitted';
            if (studentApp) {
                amenities = `
                    <div class="amenities-list">
                        <strong>Hostel:</strong> ${studentApp.hostel}<br>
                        <strong>Washroom:</strong> ${studentApp.washroom}<br>
                        <strong>Occupancy:</strong> ${studentApp.occupancy}<br>
                        <strong>Mess:</strong> ${studentApp.mess}<br>
                        <strong>Extras:</strong> ${[
                            studentApp.gym && 'Gym', 
                            studentApp.library && 'Library', 
                            studentApp.cleaner && 'Cleaner'
                        ].filter(Boolean).join(', ') || 'None'}
                    </div>
                `;
            }
            
            return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.roll}</td>
                    <td>${s.email}</td>
                    <td>${s.course}</td>
                    <td style="text-align: left;">${amenities}</td>
                </tr>
            `;
        }).join("");
    }
}

async function loadStudents() {
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
    
    try {
        // Get data from Firebase
        const studentsSnapshot = await db.collection('students').get();
        const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const applicationsSnapshot = await db.collection('applications').get();
        const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (students.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>No students registered yet.</td></tr>";
        } else {
            tbody.innerHTML = students.map(s => {
                const studentApp = applications.find(app => app.roll === s.roll);
                
                // IMPROVED: Show amenities properly
                let amenities = 'No application submitted';
                if (studentApp) {
                    amenities = `
                        <div class="amenities-list">
                            <strong>Hostel:</strong> ${studentApp.hostel}<br>
                            <strong>Washroom:</strong> ${studentApp.washroom}<br>
                            <strong>Occupancy:</strong> ${studentApp.occupancy}<br>
                            <strong>Mess:</strong> ${studentApp.mess}<br>
                            <strong>Extras:</strong> ${[
                                studentApp.gym && 'Gym', 
                                studentApp.library && 'Library', 
                                studentApp.cleaner && 'Cleaner'
                            ].filter(Boolean).join(', ') || 'None'}
                        </div>
                    `;
                }
                
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.roll}</td>
                        <td>${s.email}</td>
                        <td>${s.course}</td>
                        <td style="text-align: left;">${amenities}</td>
                    </tr>
                `;
            }).join("");
        }
    } catch (error) {
        console.error("Error loading students:", error);
        // Fallback to localStorage
        const students = JSON.parse(localStorage.getItem('students'));
        const applications = JSON.parse(localStorage.getItem('applications'));
        
        if (students.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>No students registered yet.</td></tr>";
        } else {
            tbody.innerHTML = students.map(s => {
                const studentApp = applications.find(app => app.roll === s.roll);
                
                // IMPROVED: Show amenities properly
                let amenities = 'No application submitted';
                if (studentApp) {
                    amenities = `
                        <div class="amenities-list">
                            <strong>Hostel:</strong> ${studentApp.hostel}<br>
                            <strong>Washroom:</strong> ${studentApp.washroom}<br>
                            <strong>Occupancy:</strong> ${studentApp.occupancy}<br>
                            <strong>Mess:</strong> ${studentApp.mess}<br>
                            <strong>Extras:</strong> ${[
                                studentApp.gym && 'Gym', 
                                studentApp.library && 'Library', 
                                studentApp.cleaner && 'Cleaner'
                            ].filter(Boolean).join(', ') || 'None'}
                        </div>
                    `;
                }
                
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.roll}</td>
                        <td>${s.email}</td>
                        <td>${s.course}</td>
                        <td style="text-align: left;">${amenities}</td>
                    </tr>
                `;
            }).join("");
        }
    }
    showPage("adminStudentDetails");
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeData();
    showPage('welcomePage');
});
</script>
</body>
</html>
